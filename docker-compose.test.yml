services:
  analysis-service:
    depends_on:
      - external-service
    environment:
      LLM_PROVIDER: openai
      LLM_MODEL: mock-model
      OPENAI_API_KEY: mock-key
      OPENAI_BASE_URL: http://external-service:9010

  research-service:
    depends_on:
      - external-service
    environment:
      TAVILY_API_KEY: mock-key
      TAVILY_BASE_URL: http://external-service:9010/tavily
      PUBMED_BASE_URL: http://external-service:9010/pubmed

  external-service:
    build: ./services/external-service
    ports:
      - "9010:9010"

  test-analysis:
    build:
      context: ./services/test-runner
    working_dir: /app
    volumes:
      - ./:/app
    env_file:
      - .env
    environment:
      ANALYSIS_BASE_URL: http://analysis-service:8002
    command: pytest services/analysis-service/tests/integration/test_analysis.py
    depends_on:
      - analysis-service
      - research-service
      - external-service

  test-research:
    build:
      context: ./services/test-runner
    working_dir: /app
    volumes:
      - ./:/app
    env_file:
      - .env
    environment:
      RESEARCH_BASE_URL: http://research-service:8003
    command: pytest services/research-service/tests/integration/test_research.py
    depends_on:
      - research-service
      - qdrant
      - external-service

  test-transcription:
    build:
      context: ./services/transcription-service
      dockerfile: Dockerfile.test
    environment:
      TRANSCRIPTION_URL: mock://video
      YTDLP_BIN: /app/tests/mock-yt-dlp
    command: pytest tests/integration/test_transcription.py
    depends_on:
      - transcription-service

  test-transcription-unit:
    build:
      context: ./services/transcription-service
      dockerfile: Dockerfile.test
    command: pytest tests/unit

  test-gateway:
    build:
      context: ./services/test-runner
    working_dir: /app
    volumes:
      - ./:/app
    env_file:
      - .env
    environment:
      GATEWAY_BASE_URL: http://api-gateway:8000
    command: pytest services/api-gateway/tests/integration/test_gateway.py
    depends_on:
      - api-gateway
      - external-service
      - analysis-service
      - research-service
      - transcription-service
      - postgres
      - redis

  transcription-service:
    environment:
      YTDLP_BIN: /app/mock-yt-dlp
    volumes:
      - ./services/transcription-service/tests/mock-yt-dlp:/app/mock-yt-dlp
